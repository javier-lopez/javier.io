<!DOCTYPE html>
<html>
  <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="keywords" content="Javier López personal blog">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>shrink root volumes in AWS | javier.io</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="shrink root volumes in AWS" />
<meta name="author" content="Javier López" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="shrink root volumes in AWS" />
<meta property="og:description" content="shrink root volumes in AWS" />
<link rel="canonical" href="javier.io/blog/en/2024/03/01/shrink-root-volumes-aws.html" />
<meta property="og:url" content="javier.io/blog/en/2024/03/01/shrink-root-volumes-aws.html" />
<meta property="og:site_name" content="javier.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="shrink root volumes in AWS" />
<meta name="twitter:site" content="@javier_flpz" />
<meta name="twitter:creator" content="@Javier López" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Javier López"},"dateModified":"2024-03-01T00:00:00+00:00","datePublished":"2024-03-01T00:00:00+00:00","description":"shrink root volumes in AWS","headline":"shrink root volumes in AWS","mainEntityOfPage":{"@type":"WebPage","@id":"javier.io/blog/en/2024/03/01/shrink-root-volumes-aws.html"},"url":"javier.io/blog/en/2024/03/01/shrink-root-volumes-aws.html"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" href="//javier.io/favicon.ico">
    <link href='//fonts.googleapis.com/css?family=Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>
    <!--<link href='//fonts.googleapis.com/css?family=Megrim|Ruluko|Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>-->
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
    <link rel="stylesheet" type="text/css" href="/assets/css/default_black.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/fontawesome.min.css">

    <!-- syntax http://shjs.sourceforge.net/-->
    <link type="text/css" rel="stylesheet" href="/assets/css/shjs/sh_darkness.css">

    <title>shrink root volumes in AWS</title>
  </head>

  <body onload="sh_highlightDocument('/assets/js/lang/', '.js');">
    <div id="header">
  <h1><a href="/blog/">Javier L&oacute;pez</a>
    <form>
      <input type="text" id="st-search-input" class="st-search-input"/>
    </form>
  </h1>

  <a href="/blog/en.html" class="red">[EN]</a> |
  <a href="/blog/pt.html" class="green">[PT]</a> |
  <a href="/blog/es.html" class="yellow">[ES]</a> |
  <a href="/atom.xml" class="rss">RSS</a> |

  

  <!-- Begin Swifttype -->
  <script type="text/javascript">
    var Swiftype = window.Swiftype || {};
    (function() {
      Swiftype.key = 'k64dV6Rm9QK4z8WnkrcN';
      Swiftype.inputElement = '#st-search-input';
      Swiftype.resultContainingElement = '#st-results-container';
      Swiftype.attachElement = '#st-search-input';
      Swiftype.renderStyle = "new_page";
      Swiftype.resultPageURL = "/blog/results/";

      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = "//swiftype.com/embed.js";
      var entry = document.getElementsByTagName('script')[0];
      entry.parentNode.insertBefore(script, entry);
    }());
  </script>
  <!-- End Swifttype -->


</div>


    <div id="content">
      <div id="post">
  <h2 id="shrink-root-volumes-in-aws">shrink root volumes in AWS</h2>

<h6 id="01-mar-2024">01 Mar 2024</h6>

<h2 id="volumes">Volumes</h2>

<ul>
  <li>/dev/<strong>nvme1n1</strong> → Old volume → <strong>/old</strong></li>
  <li>/dev/<strong>nvme2n1</strong> → New volume → <strong>/new</strong></li>
  <li>/dev/<strong>nvme3n1</strong> → Backup Old volume (only applicable for XFS root volumes) → <strong>/old-backup</strong></li>
</ul>

<h2 id="general-instructions">General instructions</h2>

<ol>
  <li>Create a snapshot of the root volume</li>
  <li>Stop the target instance</li>
  <li>Create a new volume with the desired size, ensure iops and speed are equal to the old volume</li>
  <li>Create a tmp ec2 instance, this is what would be used to copy data between the old / new volumes</li>
  <li>Detach the root volume from the old instance and attach it to the tmp one</li>
  <li>Attach the new volume to the tmp instance and ssh into it</li>
  <li><code class="language-plaintext highlighter-rouge">mkdir -p /old /new</code></li>
  <li><code class="language-plaintext highlighter-rouge">dd bs=16M if=/dev/nvme1n1 of=/dev/nvme2n1 count=100</code> #copy bootloader from old to the new volume</li>
  <li><code class="language-plaintext highlighter-rouge">fdisk /dev/nvme2n1</code> #format new volume
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>press 'p' take note on the start section, eg: 2048
delete the current partition with 'd'
create a new partition 'n' and use the previous start section
press 'a' to make the partition bootable
press 'w' to save changes
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">fdisk -l</code> #review than old and new volumes looks similar</li>
</ol>

<p><strong>########## ext2/3/4 ##########</strong></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">e2fsck -f /dev/nvme1n1p1</code> #check for errors in old volume</li>
  <li><code class="language-plaintext highlighter-rouge">resize2fs -M -p /dev/nvme1n1p1</code> #move the data to the beginning of the partition</li>
</ol>

<p>In the previous command’s output, the last line tells you the number of blocks.  Each block is sized 4K but when we clone the partition, we are going to do it in 16 MB blocks.  So, in order to compute the number of 16 MB, blocks, multiply the number in the last line by 4 / (16 * 1024).</p>

<p>Round this number UP (not down) to the nearest integer. Example: 1252939 (number in last line) * 4 / (16 * 1024) = 305.893310546875 … But round this UP to 306 or even 310 (it doesn’t matter as long as you don’t go below).</p>

<p><code class="language-plaintext highlighter-rouge">dd bs=16M if=/dev/nvme1n1p1 of=/dev/nvme2n1p1 count=310</code> #copy data from old to new volume</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">resize2fs -p /dev/nvme2n1p1</code> #new volume, expand fs</li>
  <li><code class="language-plaintext highlighter-rouge">e2fsck -f /dev/nvme2n1p1</code> #fix possible errors in the new volume</li>
</ol>

<p><strong>########## xfs ##########</strong></p>

<ol>
  <li>Create an additional volume same size as old volume and attached to the tmp instance. Will be use it to host a backup of the original fs, this is a workaround to xfs lack of shrinking capacity</li>
  <li><code class="language-plaintext highlighter-rouge">mkfs.xfs /dev/nvme2n1 /dev/nvme3n1</code> #format the new and the additional volume</li>
  <li><code class="language-plaintext highlighter-rouge">mount /dev/nvme1n1 /old; mount /dev/nvme2n1 /new</code></li>
  <li><code class="language-plaintext highlighter-rouge">mkdir /old-backup; mount /dev/nvme3n1 /old-backup</code></li>
  <li><code class="language-plaintext highlighter-rouge">xfsdump -L data -f /old-backup/old.xfsdump /old</code></li>
  <li><code class="language-plaintext highlighter-rouge">xfsrestore -f /old-backup/old.xfsdump /new/</code></li>
  <li><code class="language-plaintext highlighter-rouge">blkid /dev/nvme1n1p1</code> #get old uuid</li>
  <li><code class="language-plaintext highlighter-rouge">xfs_admin -U &lt;UUID from step above&gt; /dev/nvme2n1p1</code> #apply old uuid to new volume</li>
  <li><code class="language-plaintext highlighter-rouge">xfs_admin -L / /dev/nvme2n1p1</code></li>
</ol>

<h2 id="final-step">Final step</h2>

<p>Dettach the new volume, attach it to the target instance as <strong>/dev/sda1</strong> and start the instance</p>

<p>References:</p>

<ul>
  <li><a href="https://medium.com/@ztobscieng/shrink-an-amazon-aws-ebs-root-volume-2020-update-8db834265c3e">https://medium.com/@ztobscieng/shrink-an-amazon-aws-ebs-root-volume-2020-update-8db834265c3e</a> <strong>ext2/3/4</strong></li>
  <li><a href="https://medium.com/@benedikt.langens/how-to-shrink-an-ebs-root-volume-xfs-on-amazon-linux-2-2023-a7705c16e839">https://medium.com/@benedikt.langens/how-to-shrink-an-ebs-root-volume-xfs-on-amazon-linux-2-2023-a7705c16e839</a> <strong>xfs</strong></li>
</ul>

</div>

<div id="related">
  <h5>Related Entries:</h5>
  <ul class="related-posts">
    
    <li><span>22 Feb 2014</span> &raquo; <a href="/blog/en/2014/02/22/awk.html">the most portable language in the world, awk</a></li>
    
    <li><span>01 Jan 2012</span> &raquo; <a href="/blog/en/2012/01/01/bash-autocompletion.html">bash autocompletion</a></li>
    
    <li><span>22 Aug 2018</span> &raquo; <a href="/blog/en/2018/08/22/minos-a-tiling-wm-linux-distro.html">minos, a tiling wm linux distribution</a></li>
    
  </ul>
</div>

    <div id="disqus">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'javierlopez'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
     </script>
     <noscript>Enable JavaScript to see/create comments</noscript>
    </div>


    </div>

    
<div id="footer">

  <div class="link" align="right">
    <a href="//javier.io/blog"><i class="icon-pencil"></i></a>
    <a href="//javier.io/pgp"><i class="icon-key"></i></a>
    <a href="//javier.io/twitter"><i class="icon-twitter"></i></a>
    <a href="//javier.io/github"><i class="icon-github-alt"></i></a>
  </div>
</div>

    

    <!-- syntax http://shjs.sourceforge.net/-->
    <script type="text/javascript" src="/assets/js/shjs/shjs_main.js"></script>

    <!-- lightbox http://gettopup.com, the other part of the lib is called in the post.html file-->
    <script type="text/javascript" src="/assets/js/top-up/top_up-min.js"></script>
    <script type="text/javascript">TopUp.host = "//javier.io/";</script>
    <script type="text/javascript">TopUp.images_path = "assets/js/top-up/images/";</script>
    <script type="text/javascript">
      TopUp.addPresets({
          "#content strong a": {
            readAltText: 1,
            effect: "clip",
            overlayClose: 0,
            shaded: 1,
            group: "img"
          }
    });
    </script>

    <!-- google analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-47664650-1']);
      _gaq.push(['_trackPageview']);

      (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();
    </script>

  </body>
</html>
