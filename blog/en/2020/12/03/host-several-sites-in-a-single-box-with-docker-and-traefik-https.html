<!DOCTYPE html>
<html>
  <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="keywords" content="Javier López personal blog">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>host several sites in a single box with docker and traefik v2, https | javier.io</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="host several sites in a single box with docker and traefik v2, https" />
<meta name="author" content="Javier López" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="host several sites in a single box with docker and traefik v2, https" />
<meta property="og:description" content="host several sites in a single box with docker and traefik v2, https" />
<link rel="canonical" href="javier.io/blog/en/2020/12/03/host-several-sites-in-a-single-box-with-docker-and-traefik-https.html" />
<meta property="og:url" content="javier.io/blog/en/2020/12/03/host-several-sites-in-a-single-box-with-docker-and-traefik-https.html" />
<meta property="og:site_name" content="javier.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="host several sites in a single box with docker and traefik v2, https" />
<meta name="twitter:site" content="@javier_flpz" />
<meta name="twitter:creator" content="@Javier López" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Javier López"},"dateModified":"2020-12-03T00:00:00+00:00","datePublished":"2020-12-03T00:00:00+00:00","description":"host several sites in a single box with docker and traefik v2, https","headline":"host several sites in a single box with docker and traefik v2, https","mainEntityOfPage":{"@type":"WebPage","@id":"javier.io/blog/en/2020/12/03/host-several-sites-in-a-single-box-with-docker-and-traefik-https.html"},"url":"javier.io/blog/en/2020/12/03/host-several-sites-in-a-single-box-with-docker-and-traefik-https.html"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" href="//javier.io/favicon.ico">
    <link href='//fonts.googleapis.com/css?family=Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>
    <!--<link href='//fonts.googleapis.com/css?family=Megrim|Ruluko|Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>-->
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
    <link rel="stylesheet" type="text/css" href="/assets/css/default_black.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/fontawesome.min.css">

    <!-- syntax http://shjs.sourceforge.net/-->
    <link type="text/css" rel="stylesheet" href="/assets/css/shjs/sh_darkness.css">

    <title>host several sites in a single box with docker and traefik v2, https</title>
  </head>

  <body onload="sh_highlightDocument('/assets/js/lang/', '.js');">
    <div id="header">
  <h1><a href="/blog/">Javier L&oacute;pez</a>
    <form>
      <input type="text" id="st-search-input" class="st-search-input"/>
    </form>
  </h1>

  <a href="/blog/en.html" class="red">[EN]</a> |
  <a href="/blog/pt.html" class="green">[PT]</a> |
  <a href="/blog/es.html" class="yellow">[ES]</a> |
  <a href="/atom.xml" class="rss">RSS</a> |

  

  <!-- Begin Swifttype -->
  <script type="text/javascript">
    var Swiftype = window.Swiftype || {};
    (function() {
      Swiftype.key = 'k64dV6Rm9QK4z8WnkrcN';
      Swiftype.inputElement = '#st-search-input';
      Swiftype.resultContainingElement = '#st-results-container';
      Swiftype.attachElement = '#st-search-input';
      Swiftype.renderStyle = "new_page";
      Swiftype.resultPageURL = "/blog/results/";

      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = "//swiftype.com/embed.js";
      var entry = document.getElementsByTagName('script')[0];
      entry.parentNode.insertBefore(script, entry);
    }());
  </script>
  <!-- End Swifttype -->


</div>


    <div id="content">
      <div id="post">
  <h2 id="host-several-sites-in-a-single-box-with-docker-and-traefik-v2-https">host several sites in a single box with docker and traefik v2, https</h2>

<h6 id="03-dec-2020">03 Dec 2020</h6>

<p>Last time I wrote about how simple is to <a href="http://javier.io/blog/en/2020/12/01/host-several-sites-in-a-single-box-with-docker-and-traefik-http.html">host several sites with docker +
traefik on a single node</a>,
on this article I’ll complement such information with https and automatic ssl
certification renewal.</p>

<p>If you continue reading this you’ll <strong>need</strong> to get familiar with the previous
post, since I’m building upon it. OK, ready?, let’s recapitulate:</p>

<h2 id="diagram-and-folder-structure">Diagram and Folder Structure</h2>

<p><strong><a href="/assets/img/traefik-docker-compose.png"><img src="/assets/img/traefik-docker-compose.png" alt="" /></a></strong></p>

<p>Traefik will receive all requests and will send them to different containers
depending the domain/subdomains, in the process it’ll provide ssl termination
for our users and dockerized applications, those certifications will be
auto-renewed every 2/3 months and won’t require any manual step, cool!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┬
├── multisite (traefik)
│   ├── docker-compose.yml
│   ├── docker-compose.ssl.yml        =&gt; NEW FILE
│   ├── acme.json                     =&gt; NEW FILE
├── site1.com
│   ├── ...
│   ├── docker-compose.site1.yml
│   ├── docker-compose.site1.ssl.yml  =&gt; NEW FILE
├── site2.com
    ├── ...
    ├── docker-compose.site2.yml
    ├── docker-compose.site1.ssl.yml  =&gt; NEW FILE
</code></pre></div></div>

<p>As you noticed, new files were added, the idea is that we maintain the
flexibility to either provision a <strong>http only</strong> or a <strong>http + https</strong> site.</p>

<h2 id="pre-requisite-dns-configuration">pre-requisite, dns configuration</h2>

<p>When working with <strong>http only</strong> there is no need to mv our code from our local
environment, it’s easy to add some entries in <strong>/etc/hosts</strong> and call it a day,
this time however is different, we need to <strong>upload our files into a box with
a public ip address</strong> and verify that the dns routing is working as expected,
that is, if we are going to hosts these sites at:
185.199.109.153, <strong>we need to make sure site1.com / site2.com resolve to
185.199.109.153</strong></p>

<p>I won’t cover how to do that because it depends on your DNS Registrar, for
reference I’m using <a href="https://www.racknerd.com/">RackNerd</a> and
<a href="https://www.dnspod.com/">DNSPod</a> as my Linux / DNS servers.</p>

<p>Why do we need to prepare our setup like this before starting?, it has to do
with <a href="https://letsencrypt.org/">Let’s Encrypt</a>, the Certification Authority
we’re going to depend on, this CA generates challenges to verify that we are
the <strong>owners of the referenced domain/subdomain</strong>, fortunately that happens
automatically so we don’t need to do anything besides making sure that Let’s
Encrypt can communicate with our domains.</p>

<h2 id="multisite">multisite</h2>

<p>Remember that starting here all changes are located in a remote public machine.
I’ll start by creating a copy of <strong>docker-compose.yml</strong>, that would make easier
for us to track the ssl changes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp docker-compose.yml  docker-compose.ssl.yml 
</code></pre></div></div>

<p><strong>multisite/docker-compose.ssl.yml.patch</strong>:</p>

<pre class="sh_diff">
--- docker-compose.ssl.yml           2020-12-03 10:02:48.186590271 -0600
+++ docker-compose.ssl.changes.yml   2020-12-03 10:03:30.940486004 -0600
@@ -9,11 +9,21 @@
       - "--providers.docker.exposedbydefault=false"
       - "--providers.docker.network=traefik_global"
       #- "--log.level=DEBUG"
+      - "--entrypoints.http.address=:80"
+      - "--entrypoints.https.address=:443"
+      - "--certificatesresolvers.myresolver.acme.email=your-personal@email.tld"
+      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
+      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
     ports:
       - "80:80"     #reverse proxy =&gt; input to all containerized services
+      - "443:443"   #reverse ssl proxy
       - "8080:8080" #traefik dashboard/api
     volumes:
       - /var/run/docker.sock:/var/run/docker.sock
+      # Run this command in the host machine before launching traefik:
+      #   $ touch acme.json &amp;&amp; chmod 600 acme.json
+      - ${PWD}/acme.json:/acme.json
     networks:
       - traefik
</pre>

<p>Now our original file is more verbose, nevertheless every option is there for a
reason.</p>

<p>By default traefik only opens the <strong>http port (80)</strong>, so if we want to allow
both, <strong>http/https</strong>, we need to be more specific:</p>

<pre class="sh_diff">
+      - "--entrypoints.http.address=:80"
+      - "--entrypoints.https.address=:443"
</pre>

<p>We also need to select which <em>certification resolver</em>  we’re going to use, on
this case, Let’s encrypt, we specify that by filling the acme fields.</p>

<p><strong>acme.email</strong> can be any personal/business email. <strong>acme.storage</strong> is where
our ssl certificates will be saved, it does <strong>need to exists but can be
empty</strong>, if that is the case, traefik will override it with valid certs.
<strong>acme.tlschallenge</strong> is the challenge type, there are <a href="https://doc.traefik.io/traefik/https/acme/#the-different-acme-challenges">other
types</a>,
but I think this is the easiest.</p>

<pre class="sh_diff">
+      - "--certificatesresolvers.myresolver.acme.email=your-personal@email.tld"
+      - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
+      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
     ports:
       - "80:80"     #reverse proxy =&gt; input to all containerized services
+      - "443:443"   #reverse ssl proxy
</pre>

<p>Finally we’ll share the <strong>acme.json</strong> file between our host/container to avoid
requesting new certificates each time we launch our traefik container.</p>

<pre class="sh_diff">
+      # Run this command in the host machine before launching traefik:
+      #   $ touch acme.json &amp;&amp; chmod 600 acme.json
+      - ${PWD}/acme.json:/acme.json
</pre>

<p>As the comments suggest, this file needs to be created with specific
permissions before running traefik.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ touch acme.json &amp;&amp; chmod 600 acme.json
</code></pre></div></div>

<p>Ok, that’s all on traefik side, let’s apply the patch:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ patch -p0 &lt; docker-compose.ssl.yml.patch
patching file docker-compose.ssl.yml
</code></pre></div></div>

<h2 id="site1com">site1.com</h2>

<p>Let’s copy and analyze what makes a new site https compatible:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp docker-compose.site1.yml docker-compose.site1.ssl.yml
</code></pre></div></div>

<p><strong>site1.com/docker-compose.site1.ssl.yml.patch</strong>:</p>

<pre class="sh_diff">
--- docker-compose.site1.ssl.yml           2020-12-03 10:02:48.186590271 -0600
+++ docker-compose.site1.ssl.changes.yml   2020-12-03 10:03:30.940486004 -0600
@@ -28,7 +28,15 @@
       - frontend
     labels:
       - "traefik.enable=true"
-      - "traefik.http.routers.site1_com.rule=Host(`site1.com`)"
+
+      - "traefik.http.routers.http_site1_com.rule=Host(`site1.com`)"
+      - "traefik.http.routers.http_site1_com.entrypoints=http"
+
+      - "traefik.http.routers.https_site1_com.rule=Host(`site1.com`)"
+      - "traefik.http.routers.https_site1_com.entrypoints=https"
+      - "traefik.http.routers.https_site1_com.tls=true"
+      - "traefik.http.routers.https_site1_com.tls.certresolver=myresolver"
+
       - "traefik.http.services.site1_com.loadbalancer.server.port=80"
 
   app:
</pre>

<p>I don’t know about you, but for me the syntax is confusing, happily this only
needs to be setup once and then can be reused in other domains/subdomains by
changing only some words. Also, the ssl endpoint is transparent, our
application doesn’t need to be aware of it, that’s great and IMO overrides the
verbose configuration.</p>

<p>As you noticed, the <strong>site1_com</strong> rules were split in two, <strong>http_site1_com</strong>
and <strong>https_site1_com</strong>, this is because each route needs to define a Host and
an entrypoint (port), repetitive right?, in the <strong>https</strong> route we enable
<strong>tls</strong> and point to our custom resolver <strong>myresolver</strong> which if we recall uses
let’s encrypt. There is also one more detail:</p>

<pre class="sh_diff">
       - "traefik.http.services.site1_com.loadbalancer.server.port=80"
</pre>

<p>The service element redirects traefik routes to our app’s 80 port, as each
route defines a domain and entrypoint, that means it affects the domain as a
whole and therefore it’s kept as <strong>site1_com</strong> , @.@!</p>

<p>This configuration leaves an important use case that each year is more common,
forcing users to use <strong>https</strong> over <strong>http</strong>. Since I personally do not agree
with such IMO abusive behavior, I skipped it on purpose, however if you’re
interested you can use a
<a href="https://doc.traefik.io/traefik/middlewares/redirectscheme/">middleware</a> to
configure that.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ patch -p0 &lt; docker-compose.site1.yml.patch
patching file docker-compose.site1.yml
</code></pre></div></div>

<h2 id="site2com">site2.com</h2>

<p>The second site should be easier to review:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp docker-compose.site2.yml docker-compose.site2.ssl.yml
</code></pre></div></div>

<p><strong>site2.com/docker-compose.site2.ssl.yml.patch</strong>:</p>

<pre class="sh_diff">
--- docker-compose.site2.ssl.yml           2020-12-03 10:02:48.186590271 -0600
+++ docker-compose.site2.ssl.changes.yml   2020-12-03 10:03:30.940486004 -0600
@@ -26,7 +26,15 @@
       - frontend
     labels:
       - "traefik.enable=true"
-      - "traefik.http.routers.site2_com.rule=Host(`site2.com`)"
+
+      - "traefik.http.routers.http_site2_com.rule=Host(`site2.com`)"
+      - "traefik.http.routers.http_site2_com.entrypoints=http"
+
+      - "traefik.http.routers.https_site2_com.rule=Host(`site2.com`)"
+      - "traefik.http.routers.https_site2_com.entrypoints=https"
+      - "traefik.http.routers.https_site2_com.tls=true"
+      - "traefik.http.routers.https_site2_com.tls.certresolver=myresolver"
+
       - "traefik.http.services.site2_com.loadbalancer.server.port=80"
</pre>

<p>Everything is the same, the only difference is that <strong>site1</strong> was replaced with
<strong>site2</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ patch -p0 &lt; docker-compose.site2.yml.patch
patching file docker-compose.site2.yml
</code></pre></div></div>

<h2 id="docker-compose-up">docker-compose up</h2>

<p>If you’ve followed everything up until this point, <strong>congratulations!</strong>,
technology is great but also tends to be harder to grasp as more elements are
incorporated, let’s end this tutorial once for all so we can continue with our
lives:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd multisite/ &amp;&amp; docker-compose -f docker-compose.ssl.yml       up -d
$ cd site1.com/ &amp;&amp; docker-compose -f docker-compose.site1.ssl.yml up -d
$ cd site2.com/ &amp;&amp; docker-compose -f docker-compose.site2.ssl.yml up -d
</code></pre></div></div>

<p>That’s it!, a kind of simple setup with ssl certs that is only limited by
the amount of <strong>RAM/CPU</strong> in your machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl https://site1.com
hello world from 7b7d6302-e162-3806-9595-17f854dd5b98

$ curl https://site2.com; echo
{"Greetings": "Hello World!"}
</code></pre></div></div>

<p>Happy hacking!</p>

<ul>
  <li><a href="http://javier.io/blog/en/2020/12/01/host-several-sites-in-a-single-box-with-docker-and-traefik-http.html">http://javier.io/blog/en/2020/12/01/host-several-sites-in-a-single-box-with-docker-and-traefik-http.html</a></li>
  <li><a href="https://traefik.io/blog/traefik-2-0-docker-101-fc2893944b9d/">https://github.com/traefik/traefik/issues/5506#issuecomment-549100716</a></li>
</ul>

</div>

<div id="related">
  <h5>Related Entries:</h5>
  <ul class="related-posts">
    
    <li><span>01 Dec 2020</span> &raquo; <a href="/blog/en/2020/12/01/host-several-sites-in-a-single-box-with-docker-and-traefik-http.html">host several sites in a single box with docker and traefik v2, http</a></li>
    
    <li><span>22 Feb 2014</span> &raquo; <a href="/blog/en/2014/02/22/awk.html">the most portable language in the world, awk</a></li>
    
    <li><span>01 Jan 2012</span> &raquo; <a href="/blog/en/2012/01/01/bash-autocompletion.html">bash autocompletion</a></li>
    
  </ul>
</div>

    <div id="disqus">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'javierlopez'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
     </script>
     <noscript>Enable JavaScript to see/create comments</noscript>
    </div>


    </div>

    
<div id="footer">

  <div class="link" align="right">
    <a href="//javier.io/blog"><i class="icon-pencil"></i></a>
    <a href="//javier.io/pgp"><i class="icon-key"></i></a>
    <a href="//javier.io/twitter"><i class="icon-twitter"></i></a>
    <a href="//javier.io/github"><i class="icon-github-alt"></i></a>
  </div>
</div>

    

    <!-- syntax http://shjs.sourceforge.net/-->
    <script type="text/javascript" src="/assets/js/shjs/shjs_main.js"></script>

    <!-- lightbox http://gettopup.com, the other part of the lib is called in the post.html file-->
    <script type="text/javascript" src="/assets/js/top-up/top_up-min.js"></script>
    <script type="text/javascript">TopUp.host = "//javier.io/";</script>
    <script type="text/javascript">TopUp.images_path = "assets/js/top-up/images/";</script>
    <script type="text/javascript">
      TopUp.addPresets({
          "#content strong a": {
            readAltText: 1,
            effect: "clip",
            overlayClose: 0,
            shaded: 1,
            group: "img"
          }
    });
    </script>

    <!-- google analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-47664650-1']);
      _gaq.push(['_trackPageview']);

      (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();
    </script>

  </body>
</html>
