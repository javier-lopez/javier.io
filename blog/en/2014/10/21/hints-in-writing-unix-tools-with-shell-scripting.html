<!DOCTYPE html>
<html>
  <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="keywords" content="Javier López personal blog">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>hints for writing unix tools with shell scripting | javier.io</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="hints for writing unix tools with shell scripting" />
<meta name="author" content="Javier López" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="hints for writing unix tools with shell scripting" />
<meta property="og:description" content="hints for writing unix tools with shell scripting" />
<link rel="canonical" href="javier.io/blog/en/2014/10/21/hints-in-writing-unix-tools-with-shell-scripting.html" />
<meta property="og:url" content="javier.io/blog/en/2014/10/21/hints-in-writing-unix-tools-with-shell-scripting.html" />
<meta property="og:site_name" content="javier.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-10-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="hints for writing unix tools with shell scripting" />
<meta name="twitter:site" content="@javier_flpz" />
<meta name="twitter:creator" content="@Javier López" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Javier López"},"dateModified":"2014-10-21T00:00:00+00:00","datePublished":"2014-10-21T00:00:00+00:00","description":"hints for writing unix tools with shell scripting","headline":"hints for writing unix tools with shell scripting","mainEntityOfPage":{"@type":"WebPage","@id":"javier.io/blog/en/2014/10/21/hints-in-writing-unix-tools-with-shell-scripting.html"},"url":"javier.io/blog/en/2014/10/21/hints-in-writing-unix-tools-with-shell-scripting.html"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" href="//javier.io/favicon.ico">
    <link href='//fonts.googleapis.com/css?family=Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>
    <!--<link href='//fonts.googleapis.com/css?family=Megrim|Ruluko|Exo+2:200|PT+Sans|Strait|Vollkorn|' rel='stylesheet' type='text/css'>-->
    <link rel="alternate" type="application/atom+xml" href="/atom.xml">
    <link rel="stylesheet" type="text/css" href="/assets/css/default_black.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/fontawesome.min.css">

    <!-- syntax http://shjs.sourceforge.net/-->
    <link type="text/css" rel="stylesheet" href="/assets/css/shjs/sh_darkness.css">

    <title>hints for writing unix tools with shell scripting</title>
  </head>

  <body onload="sh_highlightDocument('/assets/js/lang/', '.js');">
    <div id="header">
  <h1><a href="/blog/">Javier L&oacute;pez</a>
    <form>
      <input type="text" id="st-search-input" class="st-search-input"/>
    </form>
  </h1>

  <a href="/blog/en.html" class="red">[EN]</a> |
  <a href="/blog/pt.html" class="green">[PT]</a> |
  <a href="/blog/es.html" class="yellow">[ES]</a> |
  <a href="/atom.xml" class="rss">RSS</a> |

  

  <!-- Begin Swifttype -->
  <script type="text/javascript">
    var Swiftype = window.Swiftype || {};
    (function() {
      Swiftype.key = 'k64dV6Rm9QK4z8WnkrcN';
      Swiftype.inputElement = '#st-search-input';
      Swiftype.resultContainingElement = '#st-results-container';
      Swiftype.attachElement = '#st-search-input';
      Swiftype.renderStyle = "new_page";
      Swiftype.resultPageURL = "/blog/results/";

      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = "//swiftype.com/embed.js";
      var entry = document.getElementsByTagName('script')[0];
      entry.parentNode.insertBefore(script, entry);
    }());
  </script>
  <!-- End Swifttype -->


</div>


    <div id="content">
      <div id="post">
  <h2 id="hints-for-writing-unix-tools-with-shell-scripting">hints for writing unix tools with shell scripting</h2>

<h6 id="21-oct-2014">21 Oct 2014</h6>

<p>Yesterday I started my day reading <a href="http://monkey.org/~marius/unix-tools-hints.html">Hints for writing Unix tools</a>. And since I agree to a great extend I though in giving more details about how to build such tools with my favorite language. I’d really enjoy reading similar entries aimed to other langs.</p>

<h2 id="consume-input-from-stdin-produce-output-to-stdout">Consume input from stdin, produce output to stdout</h2>

<p>In Unix you can usually refer to stdin and stdout using file descriptors 1 and 2, we do it all the time, for example to send all errors in the <code class="language-plaintext highlighter-rouge">find</code> command to /dev/null you can type:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ find / -name "*pattern*" 2&gt;/dev/null
</code></pre></div></div>

<p>And it so happens than bash/zsh/sh/ and probably many other shells can test if a fd is open and associated to a terminal with the <code class="language-plaintext highlighter-rouge">-t</code> test.</p>

<p>With this knowledge consuming input and modifying the behavior of your programs to act different depending to where it goes (pipe, file, stdout) is as easy as testing if the appropriate fd is active. For instance, to consume the standard input in your programs the following will work if placed properly (before parsing options?):</p>

<pre class="sh_sh">
if [ ! -t 0 ]; then
    #there is input comming from pipe or file, add to the end of $@
    set -- "${@}" $(cat)
fi
</pre>

<p>To control the output, you can test for fd 1 as in this example,</p>

<pre class="sh_sh">
if command -v "xclip" &gt;/dev/null 2&gt;&amp;1 || [ -t 1 ];  then
    printf "%s\\n" "${_translate_var_result}" | xclip -selection clipboard &amp;&amp; xclip -o -selection clipboard
else
    printf "%s\\n" "${_translate_var_result}"
fi
</pre>

<p>The above will allow to use <a href="https://github.com/javier-lopez/learn/blob/master/sh/tools/translate">translate</a> in the following ways:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ translate hola
$ echo hola | translate
$ echo hola | translate | sed "s:$: world:"
</code></pre></div></div>

<h2 id="output-should-be-free-from-header-or-other-decoration">Output should be free from header or other decoration</h2>

<p>Adding options in shell scripts are easy, if you like adding extra sugar to your output, consider doing it within them, some examples are; -v, –verbose, -a, –all, etc, but by default try to output the simplest response, consider <a href="https://github.com/javier-lopez/learn/blob/master/sh/tools/howdoi">howdoi</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ howdoi extract a tar.bz2 package in unix
tar -xjf /path/to/archive.tar.bz

$ howdoi -a extract a tar.bz2 package in unix
use the -j option of tar.
   tar -xjf /path/to/archive.tar.bz
-----
If it's really an old bzip 1 archive, try:
   bunzip archive.tar.bz
and you'll have a standard tar file.
Otherwise, it's the same as with .tar.bz2 files.
-----
http://stackoverflow.com/questions/9454929/how-can-i-untar-a-tar-bz-file-in-unix

$ howdoi -l extract a tar.bz2 package in unix
http://stackoverflow.com/questions/9454929/how-can-i-untar-a-tar-bz-file-in-unix
</code></pre></div></div>

<p>Global vars are a good way to track output options.</p>

<pre class="sh_sh">
for arg; do #parse options
case "${arg}" in
-a) AFLAG="set"; shift;;
-l) LFLAG="set"; shift;;
-c) CFLAG="set"; shift;;
</pre>

<h2 id="treat-a-tools-output-as-an-api">Treat a tool’s output as an API</h2>

<p>You can create tests to ensure that your output format doesn’t change and actually works. There are <a href="http://shunit.sourceforge.net/">several</a> <a href="http://bmizerany.github.io/roundup/">test suites</a> capable of managing <a href="https://github.com/lehmannro/assert.sh">shell</a> <a href="http://joyful.com/shelltestrunner/">scripts</a>, but one of the simplest is <a href="http://fossies.org/linux/shtool/test.sh">shtool test suite</a> by Ralf S. Engelschall.</p>

<p>Let’s retake the previous script and add some tests:</p>

<pre class="sh_sh">
@begin{howdoi}
howdoi; test X"${?}"                                  = X"1"
printf "%s" '-h' | howdoi; test X"${?}"               = X"1"
howdoi --help ; test X"${?}"                          = X"1"
howdoi --cui; test X"${?}"                            = X"1"
test X"$(howdoi 2&gt;&amp;1|head -1)"                        = X"Usage: howdoi [options] query ..."
test X"$(howdoi -h 2&gt;&amp;1|head -1)"                     = X"Usage: howdoi [options] query ..."
test X"$(printf "%s" '--help' | howdoi 2&gt;&amp;1|head -1)" = X"Usage: howdoi [options] query ..."
test X"$(howdoi -cui 2&gt;&amp;1|head -1)"                   = X"howdoi: unrecognized option \`-cui'"
test X"$(howdoi -n 2&gt;&amp;1|head -1)"                     = X"Option \`-n' requires a parameter"
test X"$(howdoi -n cui 2&gt;&amp;1|head -1)"                 = X"Option \`-n' requires a number: 'cui'"
test X"$(howdoi XaMTWGfu89iQpJk6 2&gt;&amp;1|head -1)"       = X"howdoi: No results"
test X"$(howdoi -C 2&gt;&amp;1)"                             = X"Cache cleared successfully"
test ! -d ~/.cache/howdoi
test X"$(howdoi XaMTWGfu89iQpJk6 2&gt;&amp;1|head -1)"       = X"howdoi: No results"
test -d ~/.cache/howdoi
@end
</pre>

<p>If you include the output format in your tests it would be harder to change it continuously.</p>

<h2 id="place-diagnostics-output-on-stderr">Place diagnostics output on stderr.</h2>

<p>This one is really easy, adding <code class="language-plaintext highlighter-rouge">&gt;&amp;2</code> to all diagnostic, help and verbose messages will do it.</p>

<pre class="sh_sh">
#before
printf "%s\\n" "$(expr "${0}" : '.*/\([^/]*\)'): unrecognized option '${arg}'"

#after
printf "%s\\n" "$(expr "${0}" : '.*/\([^/]*\)'): unrecognized option '${arg}'" &gt;&amp;2
</pre>

<h2 id="signal-failure-with-an-exit-status">Signal failure with an exit status.</h2>

<p>The current status can be set in bash/zsh/sh with either <code class="language-plaintext highlighter-rouge">true</code>, <code class="language-plaintext highlighter-rouge">: (true)</code>, <code class="language-plaintext highlighter-rouge">false</code>, <code class="language-plaintext highlighter-rouge">return</code> or <code class="language-plaintext highlighter-rouge">exit</code></p>

<p>The first three can be used to set the current status in iterations, e,g.</p>

<pre class="sh_sh">
_rdeps()
{
    [ -z "${1}" ] &amp;&amp; return 1

    for _rdeps_var_binary; do
        fpath="$(command -v "${_rdeps_var_binary}")"
        [ -z "${fpath}" ] &amp;&amp; continue

        if ldd "${fpath}" &gt;/dev/null 2&gt;/dev/null; then
            ldd "${fpath}" | sort -n | uniq | awk '{print $1}' | xargs -i apt-file search {} | cut -d':' -f1 | sort | uniq
        else
            printf "$(expr "${0}" : '.*/\([^/]*\)'): %s\\n" "not a dynamic executable '${fpath}'" &gt;&amp;2 &amp;&amp; false
        fi
    done
}
</pre>

<p>The above code will set the status to 1 without necessary quitting or returning from the function, except when no parameter is present</p>

<p><code class="language-plaintext highlighter-rouge">exit #number</code> can be used at any to exit the program with the specified status, it’s quite useful when testing for dependencies and exit with error if any of them is not available, e.g.</p>

<pre class="sh_sh">
if ! command -v "curl" &gt;/dev/null 2&gt;&amp;1; then
    printf "%s\\n" "you need to install 'curl' to run this program" &gt;&amp;2
    exit 1
fi
</pre>

<h2 id="omit-needless-diagnostics">Omit needless diagnostics.</h2>

<p>As stated in <em>Omit needless diagnostics.</em> output should be as clear and simple as possible, a verbose function can be defined and used as follows:</p>

<pre class="sh_sh">
_verbose()
{
    [ -z "${1}" ] &amp;&amp; return 1
    [ -n "${VFLAG}" ] &amp;&amp; printf "%b\\n" "${*}"
}


for arg; do #parse options
case "${arg}" in
-v|--verbose) VFLAG="set"; shift;;
...
esac

_verbose "detailed message"
</pre>

<p>And for debugging, <code class="language-plaintext highlighter-rouge">set -x</code> will help to see most of the issues most of the times.</p>

<h2 id="avoid-making-interactive-programs">Avoid making interactive programs</h2>

<p>Doing interactive programs in shell scripting is actually harder than parsing cli arguments and outputting simple strings. So it shouldn’t be difficult to follow this principle, but if you still want breaking it, ensure interactive is only an additional mode and you still have a batch one.</p>

<p>Happy tooling 😋</p>

<ul>
  <li><a href="http://monkey.org/~marius/unix-tools-hints.html">http://monkey.org/~marius/unix-tools-hints.html</a></li>
  <li><a href="https://github.com/javier-lopez/learn/blob/master/sh/guideline.md">Personal guidelines</a></li>
  <li><a href="http://f.javier.io/rep/books/Beginning_shell_scripting.pdf">Beginning shell scripting</a></li>
  <li><a href="https://github.com/javier-lopez/learn/tree/master/sh">Shell scripts following exposed advices</a></li>
</ul>

</div>

<div id="related">
  <h5>Related Entries:</h5>
  <ul class="related-posts">
    
    <li><span>01 Jan 2012</span> &raquo; <a href="/blog/en/2012/01/01/bash-autocompletion.html">bash autocompletion</a></li>
    
    <li><span>22 Feb 2014</span> &raquo; <a href="/blog/en/2014/02/22/awk.html">the most portable language in the world, awk</a></li>
    
    <li><span>10 Sep 2015</span> &raquo; <a href="/blog/en/2015/09/10/apt-packages-from-deb-postinst.html">install apt packages from deb postinst</a></li>
    
  </ul>
</div>

    <div id="disqus">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'javierlopez'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
     </script>
     <noscript>Enable JavaScript to see/create comments</noscript>
    </div>


    </div>

    
<div id="footer">

  <div class="link" align="right">
    <a href="//javier.io/blog"><i class="icon-pencil"></i></a>
    <a href="//javier.io/pgp"><i class="icon-key"></i></a>
    <a href="//javier.io/twitter"><i class="icon-twitter"></i></a>
    <a href="//javier.io/github"><i class="icon-github-alt"></i></a>
  </div>
</div>

    

    <!-- syntax http://shjs.sourceforge.net/-->
    <script type="text/javascript" src="/assets/js/shjs/shjs_main.js"></script>

    <!-- lightbox http://gettopup.com, the other part of the lib is called in the post.html file-->
    <script type="text/javascript" src="/assets/js/top-up/top_up-min.js"></script>
    <script type="text/javascript">TopUp.host = "//javier.io/";</script>
    <script type="text/javascript">TopUp.images_path = "assets/js/top-up/images/";</script>
    <script type="text/javascript">
      TopUp.addPresets({
          "#content strong a": {
            readAltText: 1,
            effect: "clip",
            overlayClose: 0,
            shaded: 1,
            group: "img"
          }
    });
    </script>

    <!-- google analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-47664650-1']);
      _gaq.push(['_trackPageview']);

      (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();
    </script>

  </body>
</html>
